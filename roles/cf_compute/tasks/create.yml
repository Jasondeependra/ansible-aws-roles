---
- name: get facts about the newly created CF Stack
  cloudformation_facts:
    stack_name: "ansible-cf-demo-network"
    region: "{{ aws_region }}"
  register: cf_network_stack_facts

- name: create a stack, pass in the template via an URL
  vars:
    network_output: "{{ cf_network_stack_facts.ansible_facts.cloudformation['ansible-cf-demo-network'].stack_outputs }}"
  cloudformation:
    stack_name: "{{ stack_name }}"
    state: present
    region: "{{ aws_region }}"
    disable_rollback: false
    template_url: "{{ template_url }}"
    template_parameters:
      VpcId: "{{ network_output.VPC }}"
      Subnets: "{{ network_output.PublicSubnets }}"
      InstanceType: "{{ instance_type }}"
      KeyName: "{{ key_name }}"
      SSHLocation: "{{ ssh_location }}"
      TagName: "{{ tag_name }}"
      TagGroup: "{{ tag_group }}"
      TagEnv: "{{ lookup('env','TAG_ENV') }}"
    tags:
      Stack: "{{ stack_name }}"